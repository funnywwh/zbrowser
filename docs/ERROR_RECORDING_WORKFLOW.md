# 编译错误自动记录工作流程

本文档说明如何自动记录编译错误并更新规则文件。

## 自动化流程

### AI自动记录流程

当AI遇到编译错误时，会自动执行以下步骤：

1. **检测编译错误**
   - 运行 `zig build` 或 `zig test` 时检测到编译错误
   - 从错误输出中提取错误信息

2. **查找现有记录**
   - 在 `docs/COMPILE_ERRORS.md` 中搜索相同或类似的错误
   - 如果找到，直接使用文档中的解决方案

3. **分析新错误**（如果未找到）
   - 提取错误类型（类型不匹配、内存管理、错误处理等）
   - 提取错误信息（完整的错误消息）
   - 分析常见原因
   - 提供解决方案
   - 总结避免规则

4. **自动记录到文档**
   - 使用标准模板添加到 `docs/COMPILE_ERRORS.md`
   - 添加到正确的分类章节
   - 更新"更新日志"部分

5. **自动更新规则**
   - 检查 `.cursorrules` 中是否已有相应规则
   - 如果没有，添加到相应的规则章节
   - 确保规则格式正确

6. **修复代码**
   - 按照解决方案修复代码
   - 验证修复后编译通过

## 错误分类映射

错误信息中的关键词可以帮助确定错误分类：

| 错误关键词 | 分类 | 章节 |
|-----------|------|------|
| `expected type`, `found type`, `type mismatch` | 类型不匹配 | 1. 类型不匹配错误 |
| `allocator`, `memory`, `deinit`, `free` | 内存管理 | 2. 内存管理错误 |
| `error`, `try`, `catch`, `!T` | 错误处理 | 3. 错误处理错误 |
| `?T`, `optional`, `null` | 可选类型 | 4. 可选类型错误 |
| `string`, `slice`, `[]const u8` | 字符串和切片 | 5. 字符串和切片错误 |
| `struct`, `field`, `function` | 结构体和函数 | 6. 结构体和函数签名错误 |
| `import`, `module`, `@import` | 导入和模块 | 7. 导入和模块错误 |
| `test`, `GeneralPurposeAllocator` | 测试相关 | 8. 测试相关错误 |
| `build.zig`, `build root` | 构建系统 | 9. 构建系统错误 |

## 标准记录模板

### 文档记录格式

```markdown
#### X.X 错误描述

**错误示例**：

```zig
完整的错误信息
```

**常见原因**：
- 原因1
- 原因2

**解决方案**：
- 解决方案1
- 解决方案2

**避免规则**：
- ✅ 规则1
- ✅ 规则2
```

### 规则更新格式

在 `.cursorrules` 的相应章节添加：

```markdown
- ✅ **规则描述**：具体说明和示例
```

## 示例：自动记录流程

### 场景：遇到类型不匹配错误

**错误信息**：
```
error: expected type '[]const u8', found '[]u8'
```

**AI自动执行**：

1. **查找现有记录**：在 `docs/COMPILE_ERRORS.md` 中找到 1.1 节已有相同错误
2. **使用现有方案**：使用 `const` 声明变量或转换类型
3. **修复代码**：应用解决方案
4. **验证**：编译通过

### 场景：遇到新错误

**错误信息**：
```
error: struct 'MyStruct' has no member named 'unknown_field'
```

**AI自动执行**：

1. **查找现有记录**：在 `docs/COMPILE_ERRORS.md` 中未找到相同错误
2. **分析错误**：
   - 类型：结构体字段错误
   - 分类：结构体和函数签名错误
   - 原因：字段名拼写错误或字段不存在
3. **自动记录**：
   - 添加到 `docs/COMPILE_ERRORS.md` 的 6.2 节（如果存在）或创建新节
   - 使用标准模板记录
   - 更新更新日志
4. **更新规则**：
   - 检查 `.cursorrules` 中"结构体和函数规则"章节
   - 如果规则不存在，添加：`- ✅ **结构体字段名必须正确**：使用IDE自动补全避免拼写错误`
5. **修复代码**：修正字段名
6. **验证**：编译通过

## 手动记录流程（备用）

如果自动化流程失败，可以手动记录：

1. 复制错误信息
2. 分析错误原因和解决方案
3. 使用模板添加到 `docs/COMPILE_ERRORS.md`
4. 更新 `.cursorrules` 中的规则（如果需要）
5. 更新文档的"更新日志"

## 验证清单

记录错误后，检查以下项目：

- [ ] 错误已添加到 `docs/COMPILE_ERRORS.md` 的正确分类
- [ ] 错误记录格式符合模板要求
- [ ] 更新日志已更新
- [ ] `.cursorrules` 中的规则已更新（如果需要）
- [ ] 代码已修复并编译通过
- [ ] 测试通过（如果有相关测试）

## 注意事项

1. **避免重复记录**：记录前先搜索是否已有相同错误
2. **分类准确**：确保错误添加到正确的分类章节
3. **规则提取**：从错误中提取通用的避免规则，不要只记录特定场景
4. **格式一致**：保持文档格式的一致性
5. **及时更新**：遇到新错误后立即记录，不要拖延

## 工具支持

### 使用脚本辅助（可选）

可以创建脚本来自动化部分流程：

```bash
# 记录编译错误（示例）
./scripts/record_error.sh "error message" "category" "solution"
```

脚本可以：
- 解析错误信息
- 自动分类
- 生成标准格式的记录
- 添加到文档

（脚本实现可根据需要添加）

---

**最后更新**：2024-XX-XX

