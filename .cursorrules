# Cursor AI开发规则 - Headless浏览器渲染引擎

## 项目概述
这是一个使用Zig 0.15.2从零开始实现的headless浏览器渲染引擎，支持HTML5、CSS3和现代JavaScript，输出PNG图片，0外部依赖。

## 环境初始化
- **必须使用 `env.sh` 初始化开发环境**
- 在开始开发前，运行 `source env.sh` 或 `. env.sh` 来设置环境变量
- `env.sh` 会将项目本地的 Zig 0.15.2 编译器路径添加到 PATH 环境变量
- 确保使用项目指定的 Zig 版本（0.15.2），避免版本不兼容问题
- 在运行任何 Zig 命令（如 `zig build`、`zig test`、`zig fmt`）之前，必须先初始化环境

## 开发规范

### 代码风格
- 使用`zig fmt`格式化所有代码
- 函数命名：camelCase
- 类型命名：PascalCase
- 常量命名：UPPER_SNAKE_CASE
- 所有公共API必须有文档注释（///）

### 内存管理
- **绝对不能有内存泄漏**：所有分配的内存必须被正确释放
- 使用Zig的内存安全特性
- 明确所有权，避免内存泄漏
- 使用Arena分配器管理DOM节点生命周期
- 大对象使用GeneralPurposeAllocator
- 每个 `init` 函数必须有对应的 `deinit` 函数
- 使用 `defer` 确保资源在函数返回前释放
- 使用 `errdefer` 确保错误路径也释放资源
- 测试代码必须使用 `GeneralPurposeAllocator` 并检查内存泄漏
- 所有通过 `allocator.alloc`、`allocator.dupe` 等分配的内存必须通过 `allocator.free` 释放
- 所有通过 `ArrayList`、`HashMap` 等数据结构分配的内存必须调用对应的 `deinit` 方法

### 错误处理
- 使用Zig的错误处理机制（Error Union Types）
- 所有可能失败的操作必须返回错误
- 提供清晰的错误信息
- HTML/CSS解析要有容错机制

### 测试要求（TDD - 测试驱动开发）
- **强制要求：必须先写测试，再写实现代码**
- 开发新功能时必须遵循TDD流程：
  1. 先编写测试用例（包括正常情况、边界条件、错误情况）
  2. 运行测试确认失败（Red）
  3. 编写最小实现使测试通过（Green）
  4. 重构代码优化实现（Refactor）
  5. 重复上述流程直到功能完成
- 每个公开函数必须有测试
- 边界条件必须有测试
- 错误情况必须有测试
- 目标：100%代码覆盖率
- 测试文件放在tests/目录，与src结构对应
- **内存泄漏检测**：所有测试必须使用 `GeneralPurposeAllocator` 并在测试结束时检查内存泄漏
- 测试中必须确保所有分配的资源都被正确释放，不能有任何内存泄漏
- **禁止先写实现代码再补测试**：必须先有测试用例

### 模块组织
- 每个模块独立，接口清晰
- 避免循环依赖
- 使用Zig的模块系统（@import）

### Chrome兼容性
- 严格遵循Chrome最新版本规范
- 参考HTML5、CSS3、ECMAScript规范
- 渲染结果要与Chrome视觉一致
- 通过Chrome对比测试验证

### 性能要求
- 关键路径要优化
- 使用缓存减少重复计算
- 考虑使用SIMD优化图像处理

### 文档要求
- 复杂算法必须有注释
- 公共API必须有文档注释
- 使用Zig文档注释格式（///）
- 所有文档文件保存在docs/目录
- API文档必须包含参数说明、返回值说明和使用示例
- 文档更新后必须同步更新docs/目录中的相应文件

## 开发流程（严格遵循TDD）
**必须严格按照以下顺序进行开发，不得跳过任何步骤：**

1. **编写测试用例（Red阶段）**
   - 先编写测试文件（tests/目录）
   - 包含正常情况、边界条件、错误情况的测试
   - 运行测试确认失败（因为实现还不存在）
   
2. **编写最小实现（Green阶段）**
   - 编写最小代码使测试通过
   - 不要过度设计，只实现测试要求的功能
   - 运行测试确认通过
   
3. **重构优化（Refactor阶段）**
   - 在测试通过的基础上优化代码
   - 提高代码质量、可读性、性能
   - 每次重构后运行测试确保仍然通过
   
4. **代码质量检查**
   - 运行 `zig fmt` 格式化代码
   - 检查linter错误并修复
   - 检查代码覆盖率（目标100%）
   - 检查内存泄漏（所有测试必须通过内存泄漏检测）

**重要原则：**
- 任何时候都不允许先写实现代码再补测试
- 如果发现缺少测试，必须先补测试，再修改实现
- 修改现有代码时，如果涉及新功能，必须先添加测试

## 禁止事项
- **绝对禁止先写实现再写测试**：必须遵循TDD，先写测试
- **绝对禁止修改不相关的代码**：只修改与当前任务直接相关的代码，不要修改其他无关的代码、函数或文件
- 不要使用外部依赖（除Zig标准库）
- 不要硬编码魔法数字
- 不要忽略错误
- 不要跳过测试
- **绝对禁止内存泄漏**：任何分配的内存必须被释放
- 不要忘记调用 `deinit` 方法
- 不要在错误路径中忘记释放资源（必须使用 `errdefer`）
- 不要在测试中忽略内存泄漏警告
- 不要在没有测试的情况下编写新功能

